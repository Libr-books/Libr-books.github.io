<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Libr - Book List</title>
  <style>
    /* Material-inspired grayscale theme */
    body {
      background-color: #eee;
      color: #212121;
      font-family: "Roboto", Arial, sans-serif;
      font-size: 16px;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 720px;
      margin: 60px auto;
      padding: 24px 32px;
      background-color: #fff;
      border-radius: 4px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      font-size: 26px;
      font-weight: 500;
      color: #212121;
      margin-bottom: 24px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }

    th, td {
      text-align: left;
      padding: 12px 8px;
      border-bottom: 1px solid #ccc;
    }

    th {
      background-color: #f5f5f5;
      color: #333;
      font-weight: 500;
    }

    a {
      color: #444;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    
a {
  padding: 10px 24px;
  margin-left: 10px;
  font-size: 14px;
  background-color: #e0e0e0;
  border: none;
  border-radius: 4px;
  color: #212121;
  box-shadow: 0 2px 2px rgba(0, 0, 0, 0.2);
  transition: background-color 0.2s ease, box-shadow 0.2s ease;
}

a:hover {
  background-color: #d5d5d5;
  box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
}

a:active {
  background-color: #cfcfcf;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}
#errorBox {
    position: fixed;
    bottom: 10px;
    left: 10px;
    right: 10px;
    background: #eee;
    color: #111;
    border: 2px solid #999;
    padding: 10px;
    font-family: Arial, sans-serif;
    font-size: 14px;
    box-shadow: 2px 2px 4px #aaa;
    z-index: 9999;
  }

  #errorContent {
    margin-bottom: 10px;
    white-space: pre-wrap;
  }

  #errorCloseBtn {
    background: #ccc;
    border: 1px solid #888;
    padding: 5px 10px;
    font-size: 14px;
    cursor: pointer;
  }

  #errorCloseBtn:hover {
    background: #bbb;
  }
  </style>
</head>
<body>
    <div class="container">
        <h1>Welcome to Project Libr</h1>
        <p>Your private ebook online selection.</p>
        <button onclick="renderBookTable(rawData)">show available books</button>
        <div class="output" id="bookTableContainer">
            <table id="table">
                <thead>
                    <tr><th>Book Name</th><th>Author</th><th>Download</th></tr>
                </thead>
                <tbody id="tbody">                    
                </tbody>
            </table>
        </div>
      </div> 
      <div id="errorBox" style="display:none;">
        <div id="errorContent"></div>
        <button id="errorCloseBtn" onclick="hideErrorBox()">Close</button>
      </div>
      
  <script type="text/javascript">
function File(type, url) {
  this.type = type;
  this.url = url;
}

// Book constructor (schema)
function Book(name, author, files) {
  this.name = name;
  this.author = author;
  this.files = files;
}

// Example raw data (JSON-like)
var rawData = [];
get("./static/books.json", function (error, data) {
  if (data) {
    var rawBooks = JSON.parse(data);

    // Map raw objects into Book instances with File instances inside
    rawData = rawBooks.map(function (rawBook) {
      // Convert raw files array into File instances
      var files = rawBook.files.map(function (rawFile) {
        return new File(rawFile.type, rawFile.url);
      });

      // Create and return a new Book instance
      return new Book(atob(rawBook.name), atob(rawBook.author), files);
    });
  }
  else{
    showErrorBox(error);
  }
});

// Render table
function renderBookTable(books) {
  var table = document.getElementById("table");
  var tbody = document.getElementById("tbody");
  for (var j = 0; j < books.length; j++) {
    var book = books[j];
    var row = document.createElement("tr");
    var nameCell = document.createElement("td");
    nameCell.appendChild(document.createTextNode(book.name));
    row.appendChild(nameCell);
    var authorCell = document.createElement("td");
    authorCell.appendChild(document.createTextNode(book.author));
    row.appendChild(authorCell);
    var urlCell = document.createElement("td");
    book.files.forEach(function (f) {
      var b = createDownloadButton(book, f);
      urlCell.appendChild(b);
    });
    row.appendChild(urlCell);
    tbody.appendChild(row);
  }
  table.appendChild(tbody);
}
function createDownloadButton(book, file) {
  var downloadButton = document.createElement("a");
  downloadButton.href = book.url;
  downloadButton.target = "_blank";
  
  downloadButton.appendChild(document.createTextNode("Download " + file.type));
  return downloadButton;
}
function fetchFileAndDecrpyt(book, file) {
  get(file.url, function (err, data) {
    if (err) {
      showErrorBox(err.message)
    } else {
      downloadDecrypted(
        data,
        (book.name + "_by_" + book.author).replaceAll(" ", "_") +
          "." +
          file.type
      );
    }
  });
}

// call this when you try to download the file
function downloadDecrypted(content, filename, type) {
  var mimeType = 'application/octet-stream';

  if (type === 'epub') {
    mimeType = 'application/epub+zip';
  } else if (type === 'mobi') {
    mimeType = 'application/x-mobipocket-ebook';
  }
  var blob = new Blob([content], {type: mimeType});
        var url = URL.createObjectURL(blob);

        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click(); 
}
function get(url, callback) {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", url, true);
  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        callback(null, xhr.responseText);
      } else {
        callback(new Error("Request failed: " + xhr.statusText));
      }
    }
  };
  xhr.send();
}

function showErrorBox(message) {
    var errorBox = document.getElementById('errorBox');
    var errorContent = document.getElementById('errorContent');
    errorContent.innerHTML = message;
    errorBox.style.display = 'block';
  }

  function hideErrorBox() {
    var errorBox = document.getElementById('errorBox');
    errorBox.style.display = 'none';
  }

  // Optional: catch global errors
  window.onerror = function (msg, url, line, col, error) {
    var info = 'JS Error: ' + msg + '\n' +
               'Line: ' + line + ', Column: ' + (col || '-') + '\n' +
               'URL: ' + (url || '-') + '\n';
    if (error && error.stack) {
      info += 'Stack:\n' + error.stack;
    }
    showErrorBox(info);
    return false; // Let browser handle too
  };

  </script>
</body>
</html>
